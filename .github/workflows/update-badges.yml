name: Update README badges

on:
  schedule:
    - cron: '0 5 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-badges:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate canonical badges and update README (no commit yet)
        env:
          OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          repos=(budget-manager portfolio-website quiz-app task-tracker weather-dashboard)
          BADGE_START='<!-- BADGES:START -->'
          BADGE_END='<!-- BADGES:END -->'
          TMP="$(mktemp)"
          TMP_BADGES="${TMP}.badges"
          {
            printf '%s\n' "$BADGE_START"
            printf '%s\n' "<!-- Generated by workflow: .github/workflows/update-badges.yml -->"
            printf '\n'
            for r in "${repos[@]}"; do
              printf '%s\n' "<!-- badges for ${r} -->"
              printf '%s\n' "[![CI](https://github.com/${OWNER}/${r}/actions/workflows/ci.yml/badge.svg)](https://github.com/${OWNER}/${r}/actions)"
              printf '%s\n' "[![Coverage](https://codecov.io/gh/${OWNER}/${r}/branch/main/graph/badge.svg)](https://codecov.io/gh/${OWNER}/${r})"
              printf '\n'
            done
            printf '%s\n' "$BADGE_END"
          } > "$TMP_BADGES"
          awk -v start="$BADGE_START" -v end="$BADGE_END" -v bfile="$TMP_BADGES" '
            BEGIN { while ((getline line < bfile) > 0) badges = badges line "\n"; printed=0; inblock=0 }
            {
              if ($0 ~ start) { if (!printed) { printf "%s", badges; printed=1 } ; inblock=1; next }
              if ($0 ~ end) { inblock=0; next }
              if (!inblock) print
            }
          ' README.md > "$TMP"
          if ! grep -qF "$BADGE_START" README.md; then
            cat "$TMP_BADGES" README.md > "$TMP"
          fi
          if cmp -s README.md "$TMP"; then
            echo "No README changes needed"
            exit 0
          fi
          mv "$TMP" README.md

      - name: Create pull request with README update (if changed)
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: chore(readme): update canonical badges
          title: chore: Update README badges
          body: |
            Automated update of the canonical badges block by workflow.
          branch: update/readme-badges
          labels: automated
          delete-branch: true
